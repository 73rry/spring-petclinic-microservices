pipeline {
    agent any

    parameters {
        string(name: 'TARGET_URL', defaultValue: 'https://spring-petclinic.antoanso.dev', description: 'Target URL to scan')
        choice(name: 'SCAN_TYPE', choices: ['baseline', 'full', 'api'], description: 'ZAP scan type: baseline (quick), full (comprehensive), or api (API scan)')
        booleanParam(name: 'FAIL_ON_HIGH', defaultValue: false, description: 'Fail build on high severity findings')
    }

    environment {
        ZAP_REPORT_DIR = "${WORKSPACE}/zap-reports"
        TIMESTAMP = sh(script: "date +%Y%m%d-%H%M%S", returnStdout: true).trim()
    }

    stages {
        stage('Prepare') {
            steps {
                script {
                    echo "Preparing ZAP security scan"
                    echo "Target URL: ${params.TARGET_URL}"
                    echo "Scan Type: ${params.SCAN_TYPE}"
                    
                    sh "mkdir -p ${ZAP_REPORT_DIR}"
                }
            }
        }

        stage('ZAP Baseline Scan') {
            when {
                expression { return params.SCAN_TYPE == 'baseline' }
            }
            steps {
                script {
                    echo "Running ZAP Baseline Scan..."
                    sh """
                        docker run --rm \
                            -v ${ZAP_REPORT_DIR}:/zap/wrk:rw \
                            -t ghcr.io/zaproxy/zaproxy:stable \
                            zap-baseline.py \
                            -t ${params.TARGET_URL} \
                            -r zap-baseline-report-${TIMESTAMP}.html \
                            -J zap-baseline-report-${TIMESTAMP}.json \
                            -w zap-baseline-report-${TIMESTAMP}.md \
                            -I || true
                    """
                }
            }
        }

        stage('ZAP Full Scan') {
            when {
                expression { return params.SCAN_TYPE == 'full' }
            }
            steps {
                script {
                    echo "Running ZAP Full Scan (this may take a while)..."
                    sh """
                        docker run --rm \
                            -v ${ZAP_REPORT_DIR}:/zap/wrk:rw \
                            -t ghcr.io/zaproxy/zaproxy:stable \
                            zap-full-scan.py \
                            -t ${params.TARGET_URL} \
                            -r zap-full-report-${TIMESTAMP}.html \
                            -J zap-full-report-${TIMESTAMP}.json \
                            -w zap-full-report-${TIMESTAMP}.md \
                            -I || true
                    """
                }
            }
        }

        stage('ZAP API Scan') {
            when {
                expression { return params.SCAN_TYPE == 'api' }
            }
            steps {
                script {
                    echo "Running ZAP API Scan..."
                    sh """
                        docker run --rm \
                            -v ${ZAP_REPORT_DIR}:/zap/wrk:rw \
                            -t ghcr.io/zaproxy/zaproxy:stable \
                            zap-api-scan.py \
                            -t ${params.TARGET_URL} \
                            -f openapi \
                            -r zap-api-report-${TIMESTAMP}.html \
                            -J zap-api-report-${TIMESTAMP}.json \
                            -w zap-api-report-${TIMESTAMP}.md \
                            -I || true
                    """
                }
            }
        }

        stage('Analyze Results') {
            steps {
                script {
                    echo "Analyzing ZAP scan results..."
                    
                    def jsonFile = sh(
                        script: "ls -t ${ZAP_REPORT_DIR}/*.json | head -1",
                        returnStdout: true
                    ).trim()
                    
                    if (jsonFile) {
                        def zapReport = readJSON file: jsonFile
                        
                        def highAlerts = 0
                        def mediumAlerts = 0
                        def lowAlerts = 0
                        
                        if (zapReport.site) {
                            zapReport.site.each { site ->
                                site.alerts?.each { alert ->
                                    switch(alert.riskcode) {
                                        case '3':
                                            highAlerts++
                                            break
                                        case '2':
                                            mediumAlerts++
                                            break
                                        case '1':
                                            lowAlerts++
                                            break
                                    }
                                }
                            }
                        }
                        
                        echo "=== ZAP Scan Results ==="
                        echo "High Risk: ${highAlerts}"
                        echo "Medium Risk: ${mediumAlerts}"
                        echo "Low Risk: ${lowAlerts}"
                        echo "======================="
                        
                        if (params.FAIL_ON_HIGH && highAlerts > 0) {
                            error("Build failed: ${highAlerts} high severity vulnerabilities found!")
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Archiving ZAP reports...'
            archiveArtifacts artifacts: 'zap-reports/*', allowEmptyArchive: true
            
            publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'zap-reports',
                reportFiles: "zap-*-report-${TIMESTAMP}.html",
                reportName: 'ZAP Security Report',
                reportTitles: 'OWASP ZAP Security Scan'
            ])
        }
        success {
            echo 'ZAP security scan completed successfully!'
        }
        failure {
            echo 'ZAP security scan failed or found critical vulnerabilities!'
        }
    }
}
